global:
  imageRegistry: ""
  imagePullSecrets: []
  defaultStorageClass: {{ coalesce .Values.pvc.keycloak.keycloak.storageClass .Values.pvc.default.storageClass | quote }}
  security:
    allowInsecureImages: true
  compatibility:
    openshift:
      adaptSecurityContext: auto


clusterDomain: {{ .Values.cluster.networking.domain | default "cluster.local" | quote }}

extraDeploy:
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      namespace: {{ .Release.Namespace }}
      labels:
        app.kubernetes.io/component: {{ .Release.Name }}-cli
        app.kubernetes.io/name: {{ .Release.Name }}-cli
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/version: 1.0.0
        app.kubernetes.io/managed-by: Helm
      name: {{ .Release.Name }}-cli
    spec:
      egress:
      - {}
      podSelector:
        matchLabels:
          app.kubernetes.io/component: keycloak-config-cli
      policyTypes:
      - Egress

image:
  registry: {{ coalesce .Values.container.keycloak.registry .Values.container.default.registry | default "docker.io" | quote }}
  repository:  {{ .Values.container.keycloak.repository | default "bitnami/keycloak" | quote }}
  tag: {{ .Values.container.keycloak.tag | default "26.2.5-debian-12-r3" | quote }}
  pullPolicy: Always
  pullSecrets:
    - {{ coalesce .Values.container.keycloak.imagePullSecret .Values.container.default.imagePullSecret | quote }}


auth:
  adminUser: {{ .Values.secret.keycloak.adminUser | quote }}
  adminPassword: {{ .Values.secret.keycloak.adminPassword | quote }}



production: true
proxyHeaders: "xforwarded"
httpEnabled: true

podSecurityContext:
  {{ .Values.security.default.podSecurityContext | toYaml | nindent 4 }}

containerSecurityContext:
  {{ .Values.security.default.containerSecurityContext | toYaml | nindent 4 }}

resourcesPreset: {{ .Values.global.resourcesPreset | quote }}

resources: {{ .Values.resource.keycloak.keycloak | default dict | toYaml | nindent 2 }}

ingress:
  enabled: true
  ingressClassName: {{.Values.cluster.ingress.className | quote }}
  pathType: ImplementationSpecific
  hostname: {{ .Values.global.hostname.keycloak }}.{{ .Values.global.domain }}
  annotations:
    {{- if .Values.cluster.ingress.annotations }}
    {{ .Values.cluster.ingress.annotations | toYaml | nindent 4 }}
    {{- end }}
    {{- if eq .Values.cluster.ingress.type "nginx" }}
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    {{- end }}
    {{- if eq .Values.cluster.ingress.type "haproxy-openshift" }}
    haproxy.router.openshift.io/hsts_header: max-age=31536000;includeSubDomains;preload
    {{- end }}
  tls: {{ .Values.global.tls.enabled | default true }}
  selfSigned: {{ and .Values.global.tls.enabled .Values.global.tls.selfSigned | default false }}
  extraTls: {{ .Values.tls.keycloak | toYaml | nindent 4 }}

networkPolicy:
  enabled: true
  extraIngress:
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: {{ .Release.Namespace }}
      - podSelector:
          matchLabels:
            app.kubernetes.io/component: keycloak-config-cli
            app.kubernetes.io/name: keycloak
      ports:
          - port: 7800
          - port: 8080

autoscaling:
  enabled: {{ .Values.autoscaling.horizontal.keycloak.enabled }}
  minReplicas: {{ .Values.autoscaling.horizontal.keycloak.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.horizontal.keycloak.maxReplicas }}
  targetCPU: {{ .Values.autoscaling.horizontal.keycloak.targetCPU }}
  targetMemory: {{ .Values.autoscaling.horizontal.keycloak.targetMemory }}

metrics:
  enabled: {{ .Values.metric.enabled | default false  }}
  serviceMonitor:
    enabled:  {{ .Values.metric.serviceMonitor.enabled | default false  }}
  prometheusRule:
    enabled: {{ .Values.metric.prometheusRule.enabled | default false  }}


keycloakConfigCli:
  enabled: true
  image:
    registry: {{ coalesce .Values.container.keycloak_cli.registry .Values.container.default.registry | default "docker.io" | quote }}
    repository:  {{ .Values.container.keycloak_cli.repository | default "bitnami/keycloak-config-cli" | quote }}
    tag: {{ .Values.container.keycloak_cli.tag | default "6.4.0-debian-12-r8" | quote }}
    pullPolicy: Always
    pullSecrets:
      - {{ coalesce .Values.container.keycloak_cli.imagePullSecret .Values.container.default.imagePullSecret | quote }}
  annotations:
    helm.sh/hook-delete-policy: "hook-succeeded,before-hook-creation"
    helm.sh/hook-weight: "5"
  resourcesPreset: {{ .Values.global.resourcesPreset | quote }}

  resources: {{ .Values.resource.keycloak.keycloak | default dict | toYaml | nindent 4 }}
  containerSecurityContext:
    {{ .Values.security.default.containerSecurityContext | toYaml | nindent 4 }}
  podSecurityContext:
    {{ .Values.security.default.podSecurityContext | toYaml | nindent 4 }}
  configuration:
    master.json: |
      {
        "realm" : "master",
        "attributes": {
          "frontendUrl": "https://{{ .Values.global.hostname.keycloak }}.{{ .Values.global.domain }}"
        }
      }
    mijnbureau.json: |
      {
        "realm" : "mijnbureau",
        "displayName": "Mijn Bureau",
        "displayNameHtml": "<b>Mijn Bureau</b>",
        "defaultSignatureAlgorithm": "RS256",
        "enabled" : true,
        "revokeRefreshToken": true,
        "editUsernameAllowed": false,
        "registrationAllowed": false,
        "duplicateEmailsAllowed": false,
        "rememberMe": true,
        "loginWithEmailAllowed": true,
        "bruteForceProtected": true,
        "permanentLockout": false,
        "maxTemporaryLockouts": 0,
        "bruteForceStrategy": "LINEAR",
        "maxFailureWaitSeconds": 900,
        "minimumQuickLoginWaitSeconds": 60,
        "waitIncrementSeconds": 60,
        "quickLoginCheckMilliSeconds": 1000,
        "maxDeltaTimeSeconds": 43200,
        "failureFactor": 30,
        "clients": [
          {
            "clientId": "{{ .Values.authentication.client.grist.client_id }}",
            "name": "Grist",
            "description": "Smart spreadsheets with Grist",
            "rootUrl": "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}/o/docs/admin",
            "baseUrl": "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.grist.client_secret | quote }},
            "redirectUris": [
              "/oauth2/callback"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": true,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.url": "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}/o/docs/logout?next=/",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.grist }}.{{ .Values.global.domain }}/*",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "backchannel.logout.revoke.offline.tokens": "false"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.synapse.client_id }}",
            "name": "Chat",
            "description": "Matrix-based chat with Synapse",
            "rootUrl": "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.synapse.client_secret | quote }},
            "redirectUris": [
              "/_synapse/client/oidc/callback"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": false,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}/_synapse/client/oidc/backchannel_logout",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.session.required": "true",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.synapse }}.{{ .Values.global.domain }}/*"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.meet.client_id }}",
            "name": "Meet",
            "description": "livekit-based video conferencing with Meet",
            "rootUrl": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.meet.client_secret | quote }},
            "redirectUris": [
              "/*"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": true,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.url": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.meet }}.{{ .Values.global.domain }}/*",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "backchannel.logout.revoke.offline.tokens": "false"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.conversations.client_id }}",
            "name": "Conversations",
            "description": "AI assistant with LaSuite conversations",
            "rootUrl": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.conversations.client_secret | quote }},
            "redirectUris": [
              "/*"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": true,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.url": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.conversations }}.{{ .Values.global.domain }}/*",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "backchannel.logout.revoke.offline.tokens": "false"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.nextcloud.client_id }}",
            "name": "NextCloud",
            "description": "File storage and collaboration platform",
            "rootUrl": "https://{{ .Values.global.hostname.nextcloud }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.nextcloud }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.nextcloud }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.nextcloud.client_secret | quote }},
            "redirectUris": [
              "/*"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.nextcloud }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": false,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.nextcloud }}.{{ .Values.global.domain }}/index.php/apps/user_oidc/backchannel-logout/keycloak",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.session.required": "true",
              "post.logout.redirect.uris": "+"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.docs.client_id }}",
            "name": "Docs",
            "description": "Docs - Eenvoudig samenwerken aan documenten",
            "rootUrl": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}",
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.docs.client_secret | quote }},
            "redirectUris": [
              "/*"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": true,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.url": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}/api/v1.0/logout/",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.docs }}.{{ .Values.global.domain }}/*",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "backchannel.logout.revoke.offline.tokens": "false"
            }
          },
          {
            "clientId": "{{ .Values.authentication.client.bureaublad.client_id }}",
            "name": "bureaublad",
            "description": "Mijn Bureau bureaublad",
            "rootUrl": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}",
            "adminUrl": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}",
            "baseUrl": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}",
            "surrogateAuthRequired": false,
            "enabled": true,
            "alwaysDisplayInConsole": true,
            "clientAuthenticatorType": "client-secret",
            "secret": {{ .Values.authentication.client.bureaublad.client_secret | quote }},
            "redirectUris": [
              "/api/v1/auth/callback"
            ],
            "webOrigins": [
              "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}"
            ],
            "notBefore": 0,
            "bearerOnly": false,
            "consentRequired": false,
            "standardFlowEnabled": true,
            "implicitFlowEnabled": false,
            "directAccessGrantsEnabled": true,
            "serviceAccountsEnabled": false,
            "publicClient": true,
            "frontchannelLogout": true,
            "protocol": "openid-connect",
            "attributes": {
              "realm_client": "false",
              "oidc.ciba.grant.enabled": "false",
              "client.secret.creation.time": "1759388679",
              "backchannel.logout.session.required": "true",
              "backchannel.logout.url": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}/api/v1/auth/logout",
              "standard.token.exchange.enabled": "false",
              "frontchannel.logout.url": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}/api/v1/auth/logout",
              "post.logout.redirect.uris": "https://{{ .Values.global.hostname.bureaublad }}.{{ .Values.global.domain }}/*",
              "frontchannel.logout.session.required": "false",
              "oauth2.device.authorization.grant.enabled": "false",
              "display.on.consent.screen": "false",
              "backchannel.logout.revoke.offline.tokens": "false"
            }
          }
        ],
        {{- if eq .Environment.Name "demo" }}
        "users" : [
          {{- $users := .Values.user }}
          {{- range $index, $user := $users }}
          {
            "username" : {{ $user.username | quote }},
            "firstName" : {{ $user.firstname | quote }},
            "lastName" : {{ $user.lastname | quote }},
            "email" : {{ $user.email | quote }},
            "emailVerified" : true,
            "credentials" : [ {
              "type" : "password",
              "value": {{ $user.password | quote }},
              "temporary": false
            } ],
            "enabled" : true
          }{{- if lt $index (sub (len $users) 1) }},{{- end }}
          {{- end }}
        ],
        {{- end }}
        "internationalizationEnabled": true,
        "eventsEnabled": true,
        "eventsExpiration": 86400,
        "adminEventsEnabled": true,
        "supportedLocales": [
          "en",
          "nl"
        ],
        "defaultLocale": "{{ .Values.global.defaultLocale }}"
      }

postgresql:
  enabled: false

externalDatabase:
  host: {{ .StateValues.database.keycloak.host | quote }}
  port: {{ .StateValues.database.keycloak.port | quote }}
  user: {{ .StateValues.database.keycloak.user | quote }}
  database: {{ .StateValues.database.keycloak.name | quote }}
  password: {{ .StateValues.database.keycloak.password | quote }}


defaultInitContainers:
  prepareWriteDirs:
    containerSecurityContext: {{ .Values.security.default.containerSecurityContext | toYaml | nindent 6 }}
    resourcesPreset: {{ .Values.global.resourcesPreset | quote }}
